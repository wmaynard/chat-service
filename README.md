# chat-service
 API for in-game social messaging

# About The Service

The Chat Service (Chat) does not differentiate between global chats, guild chats, direct messages (DMs), or any other variants.  After all, a DM is just a chat room with a limit of two people.  To minimize the number of requests, Chat returns a response containing all `RoomUpdates` with every interaction.  These `RoomUpdates` contain every unread message in every room a player is in, regardless of whether or not it's a DM, global chat, or any other room they're a member of.

Joining a room and sending a message alike should then be used to update client-side chats.  More on this in (section).

# Glossary

| Term | Definition |
| ---: | :---       |
| Room | All chat features can be broken down into **Rooms** of different types.  For example, a **direct message** is no different from a **global room** except for the fact that it can only have two members.  Other types of **room** include **guild** and **sticky**. |
| Message | A **message** is a snippet of text or data sent by a player or generated by the server, such as in the case of **broadcasts**.  For communication purposes, however, **message** should refer to player-created content. |
| Broadcast | A **broadcast** is a server-generated **message**.  It has special formatting and is programmatically created for qualifying **broadcast events**, such as summoning a very rare hero or completing certain quests. |
| Ban / Squelch | A **ban** is an administrator-issued restriction on a player's ability to interact with the service.  **Bans** may be timed or permanent.  Unlike **muting** a player, a **ban** stops them at the service-level from sending **messages**.  **Bans** do not affect **broadcasts**. |
| Mute | **Muting** a player is merely an update to their preferences.  The game client needs to actually hide messages from **muted** players. |
| Unmute | The counterpart to **mute**.  **Unmuting** a player removes them from the **muted** players list. |
| Sticky | A **sticky** or **sticky message** is a special kind of **message** that lives in its own, non-joinable **room**.  These **messages** are only viewable for a specific time period and can be used to promote events or send otherwise special server updates to players.
| PlayerInfo | To reduce bottlenecking, the chat service stores a copy of relevant player data for its own purposes.  This includes the player's avatar, screenname, discriminator, level, and power.  Other player data may be added as chat evolves.|

# Consuming The Service
Every chat-related `POST` endpoint requires the following:
* An `Authorization` header with a value set to `Bearer {token}`, where the token is issued from `player-service`.
    * This is used to authenticate the client via `player-service`'s `/player/verify` endpoint.
* A `lastRead` field, which is the Unix timestamp of the most recently-read message.
    * On the client-side, store a previous `lastRead` timestamp to send with future requests rather than sending the system's local timestamp.  This guarantees you won't miss messages.
    * While `lastRead` _can_ be `0`, this will return _all_ messages in _every_ room the player is in and is strongly discouraged.

Every JSON response contains an object that can be used to update the client, as in the sample below:

    {
        ...
        "roomUpdates": [
            {
                "id": "60e8d73536134314d16b207a",
                "unreadMessages": [
                    {
                        "id": "eda93b9a-3862-4a6f-9a73-a02fd3408a95",
                        "text": "Anger leads to hate.",
                        "timestamp": 1625872345,
                        "type": "chat",
                        "accountId": "5f727b4dc60f5a956eb1c551"
                    },
                    {
                        "id": "2eaee976-e769-4076-bdd5-d55bf6b64d70",
                        "text": "Hate leads to suffering!",
                        "timestamp": 1625872381,
                        "type": "chat",
                        "accountId": "5f727b4dc60f5a956eb1c551"
                    }
                ],
                "members": [
                    {
                        "aid": "5f727b4dc60f5a956eb1c551",
                        "avatar": "demon_axe_thrower",
                        "memberSince": 1626242762,
                        "sn": "DoktorNik",
                        "screenName": "Slartibartfast",
                        "level": 17,
                        "power": 9001,
                        "discriminator": 4539
                    },
                    {
                        "accountId": "60a43b0c70edc8aa7cf3bed6",
                        "avatar": "demon_axe_thrower",
                        "inRoomSince": 1626245489,
                        "screenName": "Arthur Dent"
                        "level": 6,
                        "power": 61,
                        "discriminator": 8039
                    }
                ],
                "previousMembers": []
            },
            {
                "id": "60ee83aa734d06135565dda7",
                "unreadMessages": [],
                "members": [
                    {
                    "accountId": "5f727b4dc60f5a956eb1c551",
                    "avatar": "demon_axe_thrower",
                    "inRoomSince": 0,
                    "screenName": "Slartibartfast"
                    }
                ]
            }
        ]
        ...
    }
In this sample, two separate `RoomUpdates` are returned.  In the first `Room`, we have two unread messages that have not been seen by the client.  The `members` field contains a list of all of a room's members so that messages can be linked to appropriate accounts, avatars, and screennames.  More data may be included in this as Chat evolves.

In the second room, there are no new messages.

_Future optimization: requests to Chat could include `Room` accountIds so that Chat can return only new members / members that have left the room, reducing data load.  Returning partial information could yield substantial data savings on every request.  The best method may be to have the client send known accountIds, then the service could return who has left the room and any new members._

# Endpoints

## Top Level

Mentioned first because of `/launch`: this endpoint is intended to be the first call to the chat service from the client.

| Method  | Endpoint  | Description | Required Parameters | Optional Parameters |
| ---:    | :---      | :---        | :---                | :---                |
| GET | `/health` | Health check; returns the status of ALL services: `banService`, `reportService`, `roomService`, and `settingsService`.  Required by the AWS Load balancer. | |
| POST | `/launch` | Launches the current player into chat.  This endpoint adds the user to a global room for their language, returns any current **sticky messages**, **bans**, **settings**, and **room updates** for the player. | `language`<br />`lastRead`<br />`playerInfo` | |

## Admin

All `Admin` endpoints other than `/admin/health` require a valid **admin token**.  For publishing app, this can be found in the dynamic config, using the `chatToken` value.  The `AdminController` class is responsible for anything requiring elevated privileges.

| Method  | Endpoint  | Description | Required Parameters | Optional Parameters |
| ---:    | :---      | :---        | :---                | :---                |
| GET | `/admin/health` | Health check; returns the status of the `BanService` and `RoomService`. | | |
| GET | `/admin/ban/list` | Lists all **bans** for all users, including expired **bans**. | | |
| GET | `/admin/rooms/list` | Lists all **rooms** and all data associated with the **rooms**.  Once live, this will probably need to be trimmed to just room IDs and basic metrics. | | |
| POST | `/admin/ban/lift` | Removes a specific **ban**, provided its ID. | `banId` | |
| POST | `/admin/ban/player` | Issues a **ban** against a player.  Can be temporary (timed) or indefinite. | `aid`<br />`reason` | `durationInSeconds`<br />`reportId` |
| POST | `/admin/messages/sticky` | Creates a **sticky message**. | `message` | `language` |
| POST | `/admin/messages/unsticky` | Deletes a **sticky message**. | `messageId` | |
| POST | `/admin/reports/ignore` | Marks a **report** as *benign*.  This does not delete the **report**, but is an indicator that it should be kept for archival purposes. | `reportId` | |
| POST | `/admin/reports/delete` | Deletes a **report**.  For clearly harmless **reports** that serve no useful purpose. | `reportId` | |
| POST | `/admin/messages/delete` | Deletes a **message**.  It would be ideal to never use this. | `messageIds`<br />`roomId` | |

## Debug

All `Debug` endpoints other than `/debug/health` are encapsulated by conditional compilation (`#if DEBUG`).  While the endpoints are not secured, they will not be available when deployed.  Once Chat is fully featured and stable, the `DebugController` should be deleted.

| Method  | Endpoint  | Description | Required Parameters | Optional Parameters |
| ---:    | :---      | :---        | :---                | :---                |
| GET | `/debug/health` | Health check; returns the status of the `RoomService` and the `SettingsService`. | | |
| POST | `/debug/rooms/clear` | Clears all `Members`, `PreviousMembers`, and `Messages` from all **rooms**. | | |
| POST | `/debug/rooms/join` | Joins the user to a **room**.  Does not leave any previous **rooms**. | `playerInfo`<br />`roomId` | | |
| POST | `/debug/settings/globalUnmute` | **Unmutes** all players from all accounts. | | |
| POST | `/debug/rooms/nuke` | Destroys all rooms.  Returns the number of destroyed **rooms**. | | |
| POST | `/debug/settings/nuke` | Destroys all user settings. | | |

## Messages

| Method  | Endpoint  | Description | Required Parameters | Optional Parameters |
| ---:    | :---      | :---        | :---                | :---                |
| GET | `/messages/health` | Health check; returns the status of the `ReportService` and the `RoomService`. | | |
| POST | `/messages/broadcast` | Sends a **broadcast**. | `aid`<br />`lastRead`<br />`message` | |
| POST | `/messages/report` | Reports a **message** for abuse.  | `lastRead`<br />`messageId`<br />`roomId` | |
| POST | `/messages/send` | Sends a **message** to a **room**.  | `lastRead`<br />`message`<br />`roomId`| |
| POST | `/messages/unread` | Retrieves all unread **messages**. | `lastRead` | |
| POST | `/messages/sticky` | Retrieves **sticky messages**. | `lastRead` | `all` |

#### Notes

* The `message` parameter is an object containing a string, `text`.  There are other fields that can be included in a `message` object, but none are useful in the context of the `MessageController`.


## Rooms

| Method  | Endpoint  | Description | Required Parameters | Optional Parameters |
| ---:    | :---      | :---        | :---                | :---                |
| GET | `/rooms/health` | Health check; returns the status of the `RoomService`. | | |
| POST | `/rooms/available` | Returns a list of available **room** for the player, as dictated by the `language` parameter. | `lastRead` | |
| POST | `/rooms/leave` | Leaves a **room**, as specified by its ID. | `lastRead`<br />`roomId` | |
| POST | `/rooms/list` | Lists all the **rooms** and all their data the user is currently in. | `lastRead` | |
| POST | `/rooms/global/join` | Joins the next available **global room**, as dictated by the `language` parameter. | `language`<br />`lastRead`<br />`playerInfo`| `roomId` |
| POST | `/rooms/global/leave` | Leaves all **global rooms** the player is currently in. This *should* only be one room, but if the client closed unexpectedly it may be more than one. | `lastRead` | |
| POST | `/rooms/update` | Updates a player's information across all of their **rooms**. | `lastRead`<br />`playerInfo` | |

#### Notes

* `/rooms/global/join` requires a **language** to be specified.  While a `roomId` can be passed in to join a specific global room, if that `roomId` is tied to a different **language**, the request will fail.  The request will also fail if the room is full.

## Settings

The `SettingsController` is responsible for storing a user's chat-specific settings.  Right now, this is limited to muted players, but could conceivably be used for other features, such as storing custom profanity filters, starred players, etc.

| Method  | Endpoint  | Description | Required Parameters | Optional Parameters |
| ---:    | :---      | :---        | :---                | :---                |
| GET | `/settings/health` | Health check; returns the status of the `SettingsService`. | | |
| GET | `/settings` | Returns all the settings for the current player. | |
| POST | `/settings/mute` | **Mutes** another player. | `playerInfo` | |
| POST | `/settings/unmute` | **Unmutes** a previously **muted** player. | `playerInfo` | | |