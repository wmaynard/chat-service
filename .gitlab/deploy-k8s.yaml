.auto-deploy:
  image: "registry.gitlab.com/gitlab-org/cluster-integration/auto-deploy-image:v2.47.0"
  dependencies: []
  needs: ["build_image"]
  allow_failure: true
  variables:
  K8S_SECRET_RUMBLE_REGION: "US"
    KUBE_CONTEXT: "platform-services/platform-services-agent:platform-services"
  script:
    - kubectl config use-context $KUBE_CONTEXT
    - auto-deploy check_kube_domain
    - auto-deploy download_chart
    - auto-deploy ensure_namespace
    - auto-deploy create_secret
    - auto-deploy deploy
  rules:
    - if: '$CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH'
      when: never
    - if: $CI_COMMIT_TAG
      when: never
    - when: manual


dev:
  extends: .auto-deploy
  stage: dev
  variables:
    KUBE_INGRESS_BASE_DOMAIN: nonprod.tower.cdrentertainment.com
    KUBE_NAMESPACE: "chat-service-8-dev"
  tags:
    - cluster
  environment:
    name: dev
    url: https://dev.nonprod.tower.cdrentertainment.com/

stage-a:
  extends: .auto-deploy
  stage: staging
  variables:
    KUBE_INGRESS_BASE_DOMAIN: nonprod.tower.cdrentertainment.com
    KUBE_NAMESPACE: "chat-service-8-stage-a"
  tags:
    - cluster
  environment:
    name: stage-a
    url: https://stage-a.nonprod.tower.cdrentertainment.com/

stage-b:
  extends: .auto-deploy
  stage: staging
  variables:
    KUBE_INGRESS_BASE_DOMAIN: nonprod.tower.cdrentertainment.com
    KUBE_NAMESPACE: "chat-service-8-stage-b"
  tags:
    - cluster
  environment:
    name: stage-b
    url: https://stage-b.nonprod.tower.cdrentertainment.com/

# stage-c:
#   extends: .auto-deploy
#   stage: staging
#   variables:
#     KUBE_INGRESS_BASE_DOMAIN: nonprod.tower.cdrentertainment.com
#     KUBE_NAMESPACE: "chat-service-8-stage-c"
#   tags:
#     - cluster
#   environment:
#     name: stage-c
#     url: https://stage-c.nonprod.tower.cdrentertainment.com/

TT-production-a1:
  extends: .auto-deploy
  stage: production
  variables:
    KUBE_CONTEXT: "platform-services/platform-services-agent:prod-a1-platform-services"
    KUBE_INGRESS_BASE_DOMAIN: prod.tower.rumblegames.com
    KUBE_NAMESPACE: "chat-service"
  tags:
    - production-a1
  environment:
    name: TT-Prod-A1
    url: https://platform-a1.prod.tower.rumblegames.com/

TT-production-a1-apse1:
  extends: .auto-deploy
  stage: production
  variables:
    KUBE_CONTEXT: "platform-services/platform-services-agent:prod-a1-apse1-platform-services"
    KUBE_INGRESS_BASE_DOMAIN: prod.tower.rumblegames.com
    KUBE_NAMESPACE: "chat-service"
    K8S_SECRET_RUMBLE_REGION: "AP"
  tags:
    - production-a1-apse1
  environment:
    name: TT-Prod-A1
    url: https://platform-a1.prod.tower.rumblegames.com/

TT-production-a2:
  extends: .auto-deploy
  stage: production-2
  variables:
    KUBE_CONTEXT: "platform-services/platform-services-agent:prod-a2-platform-services"
    KUBE_INGRESS_BASE_DOMAIN: prod.tower.rumblegames.com
    KUBE_NAMESPACE: "chat-service"
  tags:
    - production-a2
  environment:
    name: TT-Prod-A2
    url: https://platform-a2.prod.tower.rumblegames.com/

TT-production-a2-apse1:
  extends: .auto-deploy
  stage: production-2
  variables:
    KUBE_CONTEXT: "platform-services/platform-services-agent:prod-a2-apse1-platform-services"
    KUBE_INGRESS_BASE_DOMAIN: prod.tower.rumblegames.com
    KUBE_NAMESPACE: "chat-service"
    K8S_SECRET_RUMBLE_REGION: "AP"
  tags:
    - production-a2-apse1
  environment:
    name: TT-Prod-A2
    url: https://platform-a2.prod.tower.rumblegames.com/
