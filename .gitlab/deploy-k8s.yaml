.auto-deploy:
  image: "registry.gitlab.com/gitlab-org/cluster-integration/auto-deploy-image:v2.12.0"
  dependencies: []
  variables:
    KUBE_INGRESS_BASE_DOMAIN: https://dev.nonprod.tower.cdrentertainment.com/
    KUBE_NAMESPACE: "chat-service-8-dev"
    KUBE_CONTEXT: "platform-services/platform-services-agent:platform-services"
  script:
    - auto-deploy check_kube_domain
    - auto-deploy download_chart
    - auto-deploy ensure_namespace
    - auto-deploy create_secret
    - auto-deploy deploy
  rules:
    - if: '$CI_KUBERNETES_ACTIVE == null || $CI_KUBERNETES_ACTIVE == ""'
      when: never
    - if: '$CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH'
      when: never
    - if: $CI_COMMIT_TAG
      when: never
    - if: $DEPLOY_TYPE == "kubernetes" || $DEPLOY_TYPE == "both"
      when: manual
  
gitlab-test:
  image:
    name: bitnami/kubectl:latest
    entrypoint: [""]
  stage: deploy
  variables:
    AGENT_ID: 2
    K8S_PROXY_URL: "https://gitlab.cdrentertainment.com/-/kubernetes-agent/"
    KUBE_INGRESS_BASE_DOMAIN: "https://dev.nonprod.tower.cdrentertainment.com/"
    KUBE_NAMESPACE: "chat-service-8-dev"
    KUBE_CONTEXT: "platform-services/platform-services-agent:platform-services"
  before_script:
    - kubectl config get-contexts
    - cat $KUBECONFIG
    - kubectl config set-credentials agent:$AGENT_ID --token="ci:${AGENT_ID}:${CI_JOB_TOKEN}"
    - kubectl config set-cluster nonprod.us-east-1.eksctl.io --server="${K8S_PROXY_URL}"
    - kubectl config set-context "$KUBE_CONTEXT" --cluster=nonprod.us-east-1.eksctl.io --user="agent:${AGENT_ID}"
    - kubectl config use-context "$KUBE_CONTEXT"
    - kubectl config view
    - kubectl get pods -n gitlab-kubernetes-agent
  script:
  - kubectl config get-contexts
  - kubectl config use-context platform-services/platform-services-agent:platform-services
  - kubectl get pods -n gitlab-kubernetes-agent
  rules:
    - if: '$CI_KUBERNETES_ACTIVE == null || $CI_KUBERNETES_ACTIVE == ""'
      when: never
    - if: '$CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH'
      when: never
    - if: $CI_COMMIT_TAG
      when: never
    - if: $DEPLOY_TYPE == "kubernetes" || $DEPLOY_TYPE == "both"
      when: manual
  environment:
    name: dev
    url: https://dev.nonprod.tower.cdrentertainment.com/

dev:
  extends: .auto-deploy
  stage: dev
  variables:
    KUBE_INGRESS_BASE_DOMAIN: https://dev.nonprod.tower.cdrentertainment.com/
    KUBE_NAMESPACE: "chat-service-8-dev"
    KUBE_CONTEXT: "platform-services/platform-services-agent:platform-services"
  environment:
    name: dev
    url: https://dev.nonprod.tower.cdrentertainment.com/

stage-a:
  extends: .auto-deploy
  stage: staging
  environment:
    name: stage-a
    url: https://stage-a.nonprod.tower.cdrentertainment.com/

stage-b:
  extends: .auto-deploy
  stage: staging
  environment:
    name: stage-b
    url: https://stage-b.nonprod.tower.cdrentertainment.com/

stage-c:
  extends: .auto-deploy
  stage: staging
  environment:
    name: stage-c
    url: https://stage-c.nonprod.tower.cdrentertainment.com/

production:
  extends: .auto-deploy
  stage: production
  tags:
    - production
  environment:
    name: production/platform
    url: https://platform-a.prod.tower.rumblegames.com/

production-b:
  extends: .auto-deploy
  stage: production
  tags:
    - production
  environment:
    name: production/platform-b
    url: https://platform-b.prod.tower.rumblegames.com/
