variables:
  EB_DEPLOY_WAIT_TIME: 1200

dev-eb:
  stage: dev
  image: ubuntu:latest
  script:
    - apt-get update -yq
    - apt-get install -y ruby-dev zip git
    - cd bin/Release/net5.0/
    - zip -r $CI_PROJECT_NAME.zip .
    - mv $CI_PROJECT_NAME.zip $CI_PROJECT_DIR
    - cd $CI_PROJECT_DIR
    - gem install dpl --pre
    - dpl --provider=elasticbeanstalk --zip_file=./$CI_PROJECT_NAME.zip --access_key_id=$EB_DEPLOY_ACCESS_KEY --secret_access_key=$EB_DEPLOY_SECRET_KEY --bucket=rumble-gitlab-eb-platform-deploy --bucket_path=chat-service --region=us-east-1 --app=chat-service --env=ChatService-Dev --wait_until_deployed --wait_until_deployed_timeout=1200
  environment:
    name: dev-eb
  needs:
    - job: build_app
      artifacts: true
  rules:
    - if: $DEPLOY_TYPE == "kubernetes"
      when: never
    - if: $DEPLOY_TYPE == "beanstalk" || $DEPLOY_TYPE == "both"
      when: always

stage-a-eb: 
  image: ubuntu:latest
  stage: staging
  allow_failure: false
  script:
    - apt-get update -yq
    - apt-get install -y ruby-dev zip git
    - cd bin/Release/net5.0/
    - zip -r $CI_PROJECT_NAME.zip .
    - mv $CI_PROJECT_NAME.zip $CI_PROJECT_DIR
    - cd $CI_PROJECT_DIR
    - gem install dpl --pre
    - dpl --provider=elasticbeanstalk --zip_file=./$CI_PROJECT_NAME.zip --access_key_id=$EB_DEPLOY_ACCESS_KEY --secret_access_key=$EB_DEPLOY_SECRET_KEY --bucket=rumble-gitlab-eb-platform-deploy --bucket_path=chat-service --region=us-east-1 --app=chat-service --env=ChatService-Stage-A --wait_until_deployed --wait_until_deployed_timeout=1200
  environment:
    name: stage-a-eb
  needs:
    - job: build_app
      artifacts: true
  rules:
    - if: $DEPLOY_TYPE == "kubernetes"
      when: never
    - if: $DEPLOY_TYPE == "beanstalk" || $DEPLOY_TYPE == "both"
      when: manual

stage-b-eb: 
  image: ubuntu:latest
  stage: staging
  allow_failure: false
  script:
    - apt-get update -yq
    - apt-get install -y ruby-dev zip git
    - cd bin/Release/net5.0/
    - zip -r $CI_PROJECT_NAME.zip .
    - mv $CI_PROJECT_NAME.zip $CI_PROJECT_DIR
    - cd $CI_PROJECT_DIR/
    - gem install dpl --pre
    - dpl --provider=elasticbeanstalk --zip_file=./$CI_PROJECT_NAME.zip --access_key_id=$EB_DEPLOY_ACCESS_KEY --secret_access_key=$EB_DEPLOY_SECRET_KEY --bucket=rumble-gitlab-eb-platform-deploy --bucket_path=chat-service --region=us-east-1 --app=chat-service --env=ChatService-Stage-B --wait_until_deployed --wait_until_deployed_timeout=1200
  environment:
    name: stage-b-eb
  needs:
    - job: build_app
      artifacts: true
  rules:
    - if: $DEPLOY_TYPE == "kubernetes"
      when: never
    - if: $DEPLOY_TYPE == "beanstalk" || $DEPLOY_TYPE == "both"
      when: manual

prod-eb: 
  image: ubuntu:latest
  stage: production
  allow_failure: false
  script:
    - apt-get update -yq
    - apt-get install -y ruby-dev zip git
    - cd bin/Release/net5.0/
    - zip -r $CI_PROJECT_NAME.zip .
    - mv $CI_PROJECT_NAME.zip $CI_PROJECT_DIR
    - cd $CI_PROJECT_DIR/
    - gem install dpl --pre
    - dpl --provider=elasticbeanstalk --zip_file=./$CI_PROJECT_NAME.zip --access_key_id=$EB_DEPLOY_ACCESS_KEY --secret_access_key=$EB_DEPLOY_SECRET_KEY --bucket=rumble-gitlab-eb-platform-deploy --bucket_path=chat-service --region=us-east-1 --app=chat-service --env=ChatService-Prod --wait_until_deployed --wait_until_deployed_timeout=1200
  environment:
    name: prod-eb
  needs:
    - job: build_app
      artifacts: true
  rules:
    - if: $DEPLOY_TYPE == "kubernetes"
      when: never
    - if: $DEPLOY_TYPE == "beanstalk" || $DEPLOY_TYPE == "both"
      when: manual